<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Salesforce Platform Event</title>
        <link rel="stylesheet" href="sdpi.css">
        <script src="common.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsforce/1.10.0/jsforce.min.js"></script>
    </head>
    <body>
        <div class="sdpi-wrapper">
            <div class="sdpi-item">
                <div class="sdpi-item-label">Org URL</div>
                <input class="inspector sdpi-item-value" id="orgUrl" value="">
            </div>
            <div class="sdpi-item">
                <div class="sdpi-item-label">Username</div>
                <input class="inspector sdpi-item-value" id="username" value="">
            </div>
            <div class="sdpi-item">
                <div class="sdpi-item-label">Password</div>
                <input class="inspector sdpi-item-value" type="password" id="password" value="">
            </div>
            <div class="sdpi-item">
                <div class="sdpi-item-label">Event API Name</div>
                <input class="inspector sdpi-item-value" id="eventApiName" value="">
            </div>
            <div type="textarea" class="sdpi-item" id="message_only">
                <div class="sdpi-item-label">Event Payload</div>
                <span class="sdpi-item-value textarea">
                    <textarea class="inspector" type="textarea" id="eventPayload">{}</textarea>
                </span>
            </div>
            <div class="sdpi-item">
                <div class="sdpi-item-label">Are you done?</div>
                <button class="sdpi-item-value" id="save" onclick="save()">Save</button>
            </div>
        </div>
        <script>            
            if($SD) {
                $SD.on("connected", function (jsonObj) {
                    console.log(`[connected] ${JSON.stringify(jsonObj)}`);
                    if(jsonObj.hasOwnProperty('actionInfo')) {
                        settings = Utils.getProp(jsonObj, 'actionInfo.payload.settings', {});
                        document.getElementById("orgUrl").value = settings.orgUrl || "https://";
                        document.getElementById("username").value = settings.username || "example@salesforcedev.com";
                        document.getElementById("password").value = settings.password || "*******";
                        document.getElementById("eventApiName").value = settings.eventApiName || "Custom_Event__e";
                        document.getElementById("eventPayload").value = settings.eventPayload || "{Field: Value}";
                    }
                });
            };
            const save = function() {
                if($SD) {
                    var payload = {};
                    [].forEach.call(document.querySelectorAll(".inspector"), element => {
                        payload[element.id] = element.value;
                    });
                    $SD.api.sendToPlugin($SD.uuid, $SD.actionInfo["action"], payload);
                }
            }
        </script>
    </body>
</html>
